<!DOCTYPE html><html lang="en"><head><title>assets/scripts/vendor/backbone_localStorage</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="assets/scripts/vendor/backbone_localStorage"><meta name="groc-project-path" content="assets/scripts/vendor/backbone_localStorage.js"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">assets/scripts/vendor/backbone_localStorage.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Backbone localStorage Adapter
Version 1.1.14</p>
<p><a href="https://github.com/jeromegn/Backbone.localStorage">https://github.com/jeromegn/Backbone.localStorage</a></p></div></div><div class="code"><div class="wrapper">(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(root, factory)</span> {</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> exports === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">require</span> === <span class="hljs-string">'function'</span>) {
    module.exports = factory(<span class="hljs-built_in">require</span>(<span class="hljs-string">"backbone"</span>));
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">"function"</span> &amp;&amp; define.amd) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>AMD. Register as an anonymous module.</p></div></div><div class="code"><div class="wrapper">    define([<span class="hljs-string">"backbone"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Backbone)</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Use global variables if the locals are undefined.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span> factory(Backbone || root.Backbone);
    });
  } <span class="hljs-keyword">else</span> {
    factory(Backbone);
  }
}(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Backbone)</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A simple module to replace <code>Backbone.sync</code> with <em>localStorage</em>-based
persistence. Models are given GUIDS, and saved into a JSON object. Simple
as that.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Generate four random hex digits.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">S4</span><span class="hljs-params">()</span> {</span>
   <span class="hljs-keyword">return</span> (((<span class="hljs-number">1</span>+<span class="hljs-built_in">Math</span>.random())*<span class="hljs-number">0x10000</span>)|<span class="hljs-number">0</span>).toString(<span class="hljs-number">16</span>).substring(<span class="hljs-number">1</span>);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Generate a pseudo-GUID by concatenating random hexadecimal.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">guid</span><span class="hljs-params">()</span> {</span>
   <span class="hljs-keyword">return</span> (S4()+S4()+<span class="hljs-string">"-"</span>+S4()+<span class="hljs-string">"-"</span>+S4()+<span class="hljs-string">"-"</span>+S4()+<span class="hljs-string">"-"</span>+S4()+S4()+S4());
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isObject</span><span class="hljs-params">(item)</span> {</span>
  <span class="hljs-keyword">return</span> item === <span class="hljs-built_in">Object</span>(item);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">contains</span><span class="hljs-params">(array, item)</span> {</span>
  <span class="hljs-keyword">var</span> i = array.length;
  <span class="hljs-keyword">while</span> (i--) <span class="hljs-keyword">if</span> (array[i] === item) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">extend</span><span class="hljs-params">(obj, props)</span> {</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> props) obj[key] = props[key]
  <span class="hljs-keyword">return</span> obj;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">result</span><span class="hljs-params">(object, property)</span> {</span>
    <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> value = object[property];
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span>) ? object[property]() : value;
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Our Store is represented by a single JS object in <em>localStorage</em>. Create it
with a meaningful name, like the name you&#39;d give a table.
window.Store is deprectated, use Backbone.LocalStorage instead</p></div></div><div class="code"><div class="wrapper">Backbone.LocalStorage = window.Store = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, serializer)</span> {</span>
  <span class="hljs-keyword">if</span>( !<span class="hljs-keyword">this</span>.localStorage ) {
    <span class="hljs-keyword">throw</span> <span class="hljs-string">"Backbone.localStorage: Environment does not support localStorage."</span>
  }
  <span class="hljs-keyword">this</span>.name = name;
  <span class="hljs-keyword">this</span>.serializer = serializer || {
    serialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
      <span class="hljs-keyword">return</span> isObject(item) ? <span class="hljs-built_in">JSON</span>.stringify(item) : item;
    },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>fix for &quot;illegal access&quot; error on Android when JSON.parse is passed null</p></div></div><div class="code"><div class="wrapper">    deserialize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
      <span class="hljs-keyword">return</span> data &amp;&amp; <span class="hljs-built_in">JSON</span>.parse(data);
    }
  };
  <span class="hljs-keyword">var</span> store = <span class="hljs-keyword">this</span>.localStorage().getItem(<span class="hljs-keyword">this</span>.name);
  <span class="hljs-keyword">this</span>.records = (store &amp;&amp; store.split(<span class="hljs-string">","</span>)) || [];
};

extend(Backbone.LocalStorage.prototype, {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save the current state of the <strong>Store</strong> to <em>localStorage</em>.</p></div></div><div class="code"><div class="wrapper">  save: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.localStorage().setItem(<span class="hljs-keyword">this</span>.name, <span class="hljs-keyword">this</span>.records.join(<span class="hljs-string">","</span>));
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add a model, giving it a (hopefully)-unique GUID, if it doesn&#39;t already
have an id of it&#39;s own.</p></div></div><div class="code"><div class="wrapper">  create: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> {</span>
    <span class="hljs-keyword">if</span> (!model.id &amp;&amp; model.id !== <span class="hljs-number">0</span>) {
      model.id = guid();
      model.set(model.idAttribute, model.id);
    }
    <span class="hljs-keyword">this</span>.localStorage().setItem(<span class="hljs-keyword">this</span>._itemName(model.id), <span class="hljs-keyword">this</span>.serializer.serialize(model));
    <span class="hljs-keyword">this</span>.records.push(model.id.toString());
    <span class="hljs-keyword">this</span>.save();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.find(model);
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update a model by replacing its copy in <code>this.data</code>.</p></div></div><div class="code"><div class="wrapper">  update: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> {</span>
    <span class="hljs-keyword">this</span>.localStorage().setItem(<span class="hljs-keyword">this</span>._itemName(model.id), <span class="hljs-keyword">this</span>.serializer.serialize(model));
    <span class="hljs-keyword">var</span> modelId = model.id.toString();
    <span class="hljs-keyword">if</span> (!contains(<span class="hljs-keyword">this</span>.records, modelId)) {
      <span class="hljs-keyword">this</span>.records.push(modelId);
      <span class="hljs-keyword">this</span>.save();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.find(model);
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Retrieve a model from <code>this.data</code> by id.</p></div></div><div class="code"><div class="wrapper">  find: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.serializer.deserialize(<span class="hljs-keyword">this</span>.localStorage().getItem(<span class="hljs-keyword">this</span>._itemName(model.id)));
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Return the array of all models currently in storage.</p></div></div><div class="code"><div class="wrapper">  findAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> result = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, id, data; i &lt; <span class="hljs-keyword">this</span>.records.length; i++) {
      id = <span class="hljs-keyword">this</span>.records[i];
      data = <span class="hljs-keyword">this</span>.serializer.deserialize(<span class="hljs-keyword">this</span>.localStorage().getItem(<span class="hljs-keyword">this</span>._itemName(id)));
      <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span>) result.push(data);
    }
    <span class="hljs-keyword">return</span> result;
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Delete a model from <code>this.data</code>, returning it.</p></div></div><div class="code"><div class="wrapper">  destroy: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> {</span>
    <span class="hljs-keyword">this</span>.localStorage().removeItem(<span class="hljs-keyword">this</span>._itemName(model.id));
    <span class="hljs-keyword">var</span> modelId = model.id.toString();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, id; i &lt; <span class="hljs-keyword">this</span>.records.length; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.records[i] === modelId) {
        <span class="hljs-keyword">this</span>.records.splice(i, <span class="hljs-number">1</span>);
      }
    }
    <span class="hljs-keyword">this</span>.save();
    <span class="hljs-keyword">return</span> model;
  },

  localStorage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> localStorage;
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clear localStorage for specific collection.</p></div></div><div class="code"><div class="wrapper">  _clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> local = <span class="hljs-keyword">this</span>.localStorage(),
      itemRe = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">"^"</span> + <span class="hljs-keyword">this</span>.name + <span class="hljs-string">"-"</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remove id-tracking item (e.g., &quot;foo&quot;).</p></div></div><div class="code"><div class="wrapper">    local.removeItem(<span class="hljs-keyword">this</span>.name);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Match all data items (e.g., &quot;foo-ID&quot;) and remove.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> local) {
      <span class="hljs-keyword">if</span> (itemRe.test(k)) {
        local.removeItem(k);
      }
    }

    <span class="hljs-keyword">this</span>.records.length = <span class="hljs-number">0</span>;
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Size of localStorage.</p></div></div><div class="code"><div class="wrapper">  _storageSize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.localStorage().length;
  },

  _itemName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name+<span class="hljs-string">"-"</span>+id;
  }

});</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>localSync delegate to the model or collection&#39;s
<em>localStorage</em> property, which should be an instance of <code>Store</code>.
window.Store.sync and Backbone.localSync is deprecated, use Backbone.LocalStorage.sync instead</p></div></div><div class="code"><div class="wrapper">Backbone.LocalStorage.sync = window.Store.sync = Backbone.localSync = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method, model, options)</span> {</span>
  <span class="hljs-keyword">var</span> store = result(model, <span class="hljs-string">'localStorage'</span>) || result(model.collection, <span class="hljs-string">'localStorage'</span>);

  <span class="hljs-keyword">var</span> resp, errorMessage;
  <span class="hljs-comment">//If $ is having Deferred - use it.</span>
  <span class="hljs-keyword">var</span> syncDfd = Backbone.$ ?
    (Backbone.$.Deferred &amp;&amp; Backbone.$.Deferred()) :
    (Backbone.Deferred &amp;&amp; Backbone.Deferred());

  <span class="hljs-keyword">try</span> {

    <span class="hljs-keyword">switch</span> (method) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"read"</span>:
        resp = model.id != <span class="hljs-literal">undefined</span> ? store.find(model) : store.findAll();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"create"</span>:
        resp = store.create(model);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"update"</span>:
        resp = store.update(model);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"delete"</span>:
        resp = store.destroy(model);
        <span class="hljs-keyword">break</span>;
    }

  } <span class="hljs-keyword">catch</span>(error) {
    <span class="hljs-keyword">if</span> (error.code === <span class="hljs-number">22</span> &amp;&amp; store._storageSize() === <span class="hljs-number">0</span>)
      errorMessage = <span class="hljs-string">"Private browsing is unsupported"</span>;
    <span class="hljs-keyword">else</span>
      errorMessage = error.message;
  }

  <span class="hljs-keyword">if</span> (resp) {
    <span class="hljs-keyword">if</span> (options &amp;&amp; options.success) {
      <span class="hljs-keyword">if</span> (Backbone.VERSION === <span class="hljs-string">"0.9.10"</span>) {
        options.success(model, resp, options);
      } <span class="hljs-keyword">else</span> {
        options.success(resp);
      }
    }
    <span class="hljs-keyword">if</span> (syncDfd) {
      syncDfd.resolve(resp);
    }

  } <span class="hljs-keyword">else</span> {
    errorMessage = errorMessage ? errorMessage
                                : <span class="hljs-string">"Record Not Found"</span>;

    <span class="hljs-keyword">if</span> (options &amp;&amp; options.error)
      <span class="hljs-keyword">if</span> (Backbone.VERSION === <span class="hljs-string">"0.9.10"</span>) {
        options.error(model, errorMessage, options);
      } <span class="hljs-keyword">else</span> {
        options.error(errorMessage);
      }

    <span class="hljs-keyword">if</span> (syncDfd)
      syncDfd.reject(errorMessage);
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>add compatibility with $.ajax
always execute callback for success and error</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (options &amp;&amp; options.complete) options.complete(resp);

  <span class="hljs-keyword">return</span> syncDfd &amp;&amp; syncDfd.promise();
};

Backbone.ajaxSync = Backbone.sync;

Backbone.getSyncMethod = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> {</span>
  <span class="hljs-keyword">if</span>(model.localStorage || (model.collection &amp;&amp; model.collection.localStorage)) {
    <span class="hljs-keyword">return</span> Backbone.localSync;
  }

  <span class="hljs-keyword">return</span> Backbone.ajaxSync;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Override &#39;Backbone.sync&#39; to default to localSync,
the original &#39;Backbone.sync&#39; is still available in &#39;Backbone.ajaxSync&#39;</p></div></div><div class="code"><div class="wrapper">Backbone.sync = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method, model, options)</span> {</span>
  <span class="hljs-keyword">return</span> Backbone.getSyncMethod(model).apply(<span class="hljs-keyword">this</span>, [method, model, options]);
};

<span class="hljs-keyword">return</span> Backbone.LocalStorage;
}));</div></div></div></div></body></html>